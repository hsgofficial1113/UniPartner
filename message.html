<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UniPartner | Chat</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Inter:wght@400;600&family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME --- */
        :root {
            --bg-dark: #000000;
            --accent: #bc13fe; 
            --success: #00ff88;
            --danger: #ff0055;
            --read-color: #00bfff;
            --text-main: #ffffff;
            --border: #333;
            --font-body: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-body); }
        body { background-color: var(--bg-dark); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 80px; background: #050505; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; flex-shrink: 0; }
        .nav-icon { color: #666; font-size: 1.5rem; margin-bottom: 30px; cursor: pointer; transition: 0.3s; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; text-decoration: none; }
        .nav-icon:hover, .nav-icon.active { background: rgba(188, 19, 254, 0.1); color: var(--accent); }

        /* LAYOUT */
        .chat-container { display: flex; width: 100%; height: 100%; position: relative; overflow: hidden; }
        .contact-list { width: 320px; background: #0a0a0a; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 5; }
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; text-align: center; color: #555; z-index: 1; }
        .chat-area { display: none; flex: 1; flex-direction: column; background: #000; position: relative; z-index: 10; }

        /* INBOX LIST */
        .search-bar { padding: 20px; border-bottom: 1px solid var(--border); }
        .search-bar input { width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 12px 15px; border-radius: 8px; color: white; outline: none; font-size: 1rem; }
        .users-scroll { flex: 1; overflow-y: auto; }
        
        .user-item { display: flex; align-items: center; gap: 15px; padding: 15px 20px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #1a1a1a; position: relative; }
        .user-item:hover { background: rgba(188, 19, 254, 0.05); }
        .user-item.active-chat { background: rgba(188, 19, 254, 0.1); border-left: 3px solid var(--accent); }
        
        .u-avatar { width: 50px; height: 50px; border-radius: 50%; background: #222; background-size: cover; background-position: center; border: 2px solid var(--border); flex-shrink: 0; }
        .u-info { flex: 1; overflow: hidden; }
        .u-info h4 { font-size: 0.95rem; color: #eee; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .u-info p { font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .unread-badge { background: var(--success); color: black; font-size: 0.7rem; font-weight: bold; padding: 2px 6px; border-radius: 10px; margin-left: auto; display: none; }
        .user-item.has-unread .unread-badge { display: inline-block; }

        /* CHAT HEADER */
        .chat-header { padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(10,10,10,0.95); height: 70px; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .status-badge { font-size: 0.75rem; display: flex; align-items: center; gap: 6px; margin-top: 2px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot.offline { background: #666; }
        
        /* --- MESSAGES ALIGNMENT & COLORS --- */
        .messages-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; position: relative; }
        
        /* SENT (Right) */
        .msg-wrapper.sent { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.sent .msg { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .msg-wrapper.sent .action-triggers { left: -75px; } /* Controls to the left */

        /* RECEIVED (Left) */
        .msg-wrapper.received { align-self: flex-start; align-items: flex-start; }
        .msg-wrapper.received .msg { background: #222; color: #ddd; border-bottom-left-radius: 4px; }
        .msg-wrapper.received .action-triggers { right: -40px; } /* Controls to the right */

        .msg { padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; position: relative; }
        
        .msg-meta { font-size: 0.65rem; margin-top: 4px; display: flex; gap: 6px; opacity: 0.7; }
        .status-text { font-weight: 700; text-transform: uppercase; font-size: 0.6rem; letter-spacing: 0.5px; }
        .status-text.read { color: var(--read-color); }
        .status-text.sent { color: #888; }

        .quoted-msg { background: rgba(0,0,0,0.3); border-left: 3px solid rgba(255,255,255,0.6); padding: 8px 10px; border-radius: 6px; font-size: 0.8rem; margin-bottom: 8px; text-align: left; }

        /* ACTION TRIGGERS */
        .action-triggers { position: absolute; top: 5px; display: flex; gap: 5px; opacity: 0; transition: 0.2s; }
        .msg-wrapper:hover .action-triggers { opacity: 1; }
        
        .msg-btn { width: 28px; height: 28px; border-radius: 50%; background: #1a1a1a; color: #888; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; border: 1px solid #333; }
        .msg-btn:hover { background: #333; color: white; }
        .btn-del:hover { background: var(--danger); border-color: var(--danger); }

        /* INPUT AREA */
        .input-container { background: #0a0a0a; border-top: 1px solid var(--border); position: relative; }
        .reply-preview { background: #151515; padding: 10px 20px; border-bottom: 1px solid #333; display: none; align-items: center; justify-content: space-between; border-left: 4px solid var(--accent); }
        .reply-preview.active { display: flex; }
        
        .emoji-picker { position: absolute; bottom: 70px; left: 10px; background: #111; border: 1px solid #333; padding: 10px; border-radius: 12px; display: none; grid-template-columns: repeat(6, 1fr); gap: 10px; z-index: 20; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .emoji-item { font-size: 1.5rem; cursor: pointer; text-align: center; }

        .input-area { padding: 15px; display: flex; gap: 10px; align-items: center; }
        .input-area input { flex: 1; background: #1a1a1a; border: 1px solid #333; padding: 14px 20px; border-radius: 50px; color: white; outline: none; font-size: 1rem; }
        .icon-btn { color: #888; font-size: 1.3rem; background: none; border: none; cursor: pointer; }
        .send-btn { width: 45px; height: 45px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; cursor: pointer; font-size: 1.1rem; }

        /* RESPONSIVE */
        .bottom-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar, .empty-state { display: none; } 
            .contact-list { width: 100%; } 
            .chat-area { position: fixed; inset: 0; z-index: 50; transform: translateX(100%); transition: transform 0.3s; }
            .chat-area.active { transform: translateX(0%); }
            .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid #333; justify-content: space-around; align-items: center; z-index: 40; }
            .bottom-nav a { font-size: 1.4rem; color: #666; }
            .bottom-nav a.active { color: var(--accent); }
            .users-scroll { padding-bottom: 70px; }
        }
    </style>
</head>
<body>

    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <div class="sidebar">
        <a href="dashboard.html" class="nav-icon"><i class="fa-solid fa-graduation-cap"></i></a>
        <a href="matching.html" class="nav-icon"><i class="fa-solid fa-heart-pulse"></i></a>
        <div class="nav-icon active"><i class="fa-regular fa-comments"></i></div>
    </div>

    <div class="bottom-nav">
        <a href="dashboard.html"><i class="fa-solid fa-graduation-cap"></i></a>
        <a href="matching.html"><i class="fa-solid fa-heart-pulse"></i></a>
        <a href="#" class="active"><i class="fa-solid fa-comments"></i></a>
    </div>

    <div class="chat-container">
        <div class="contact-list" id="contact-list">
            <div class="search-bar"><input type="text" id="search-user" placeholder="Search chats..." onkeyup="filterUsers()"></div>
            <div class="users-scroll" id="users-grid">
                <p style="text-align:center; color:#555; margin-top:20px;">Loading Inbox...</p>
            </div>
        </div>

        <div class="empty-state" id="empty-state">
            <i class="fa-regular fa-comments" style="font-size:4rem; margin-bottom:20px; color:#222;"></i>
            <h2>UniPartner</h2><p>Select a chat to view messages</p>
        </div>

        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <div class="header-left">
                    <i class="fa-solid fa-arrow-left" style="cursor:pointer; font-size:1.2rem; color:#ccc; display:none;" onclick="closeChat()" id="back-btn"></i>
                    <div class="u-avatar" id="chat-header-pic" style="width:35px; height:35px;"></div>
                    <div>
                        <h3 id="chat-header-name">User</h3>
                        <div class="status-badge" id="chat-header-status">
                            <span class="dot offline"></span> <span>Offline</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-box" id="messages-box"></div>

            <div class="input-container">
                <div class="reply-preview" id="reply-bar">
                    <div><span style="color:var(--accent); font-size:0.7rem; font-weight:bold;">Replying to</span><div class="reply-content" id="reply-text">...</div></div>
                    <i class="fa-solid fa-xmark icon-btn" onclick="cancelReply()"></i>
                </div>

                <div class="emoji-picker" id="emoji-picker">
                    <div class="emoji-item" onclick="addEmoji('üòÇ')">üòÇ</div>
                    <div class="emoji-item" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                    <div class="emoji-item" onclick="addEmoji('üòç')">üòç</div>
                    <div class="emoji-item" onclick="addEmoji('üëç')">üëç</div>
                    <div class="emoji-item" onclick="addEmoji('üòä')">üòä</div>
                    <div class="emoji-item" onclick="addEmoji('üò≠')">üò≠</div>
                    <div class="emoji-item" onclick="addEmoji('üî•')">üî•</div>
                    <div class="emoji-item" onclick="addEmoji('üíÄ')">üíÄ</div>
                </div>

                <div class="input-area">
                    <button class="icon-btn" onclick="toggleEmoji()"><i class="fa-regular fa-face-smile"></i></button>
                    <input type="text" id="msg-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
                    <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qfphldkagncbdayxbwkm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcGhsZGthZ25jYmRheXhid2ttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMjEwNDUsImV4cCI6MjA4NDg5NzA0NX0.1wFaOihsBx5dMkVzHviqDEwAKd9EDnNIr1WqpPVgJLY';
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let activeChatUser = null;
        let messageSubscription = null;
        let currentReplyId = null;
        let currentReplyContent = null;
        let userListCache = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await client.auth.getSession();
            if (!session) { window.location.href = 'auth.html'; return; }
            currentUser = session.user;
            
            updateMyStatus();
            setInterval(updateMyStatus, 60000); 

            await loadInbox(); 
            setupRealtime();
            const pendingUserId = localStorage.getItem('active_chat_user');
            if (pendingUserId) { openChat(pendingUserId); localStorage.removeItem('active_chat_user'); }
        });

        async function updateMyStatus() {
            await client.from('profiles').update({ last_seen: new Date().toISOString() }).eq('id', currentUser.id);
        }

        async function loadInbox() {
            const { data: msgs } = await client.from('messages')
                .select('sender_id, receiver_id, content, created_at, is_read')
                .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });

            const userMap = new Map();
            if (msgs) {
                for (const m of msgs) {
                    const partnerId = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
                    if (!userMap.has(partnerId)) userMap.set(partnerId, { id: partnerId, lastMsg: m.content, time: m.created_at, unread: 0 });
                    if (m.receiver_id === currentUser.id && m.is_read === false) userMap.get(partnerId).unread++;
                }
            }
            if (userMap.size === 0) { document.getElementById('users-grid').innerHTML = '<p style="text-align:center;margin-top:20px;color:#555">No chats yet.</p>'; return; }
            const { data: profiles } = await client.from('profiles').select('*').in('id', Array.from(userMap.keys()));
            userListCache = profiles.map(p => ({ ...p, ...userMap.get(p.id) }));
            renderUserList();
        }

        function renderUserList() {
            userListCache.sort((a,b) => new Date(b.time) - new Date(a.time));
            const grid = document.getElementById('users-grid');
            grid.innerHTML = "";
            userListCache.forEach(u => {
                const pic = u.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${u.first_name}`;
                grid.innerHTML += `<div class="user-item ${u.unread > 0 ? 'has-unread' : ''} ${u.id === activeChatUser ? 'active-chat' : ''}" onclick="openChat('${u.id}')"><div class="u-avatar" style="background-image: url('${pic}')"></div><div class="u-info"><h4>${u.first_name} ${u.last_name} <span style="font-size:0.7rem; color:#666; font-weight:normal;">${formatTime(u.time)}</span></h4><p>${u.lastMsg}</p></div><div class="unread-badge">${u.unread}</div></div>`;
            });
        }

        async function openChat(userId) {
            activeChatUser = userId;
            const user = userListCache.find(u => u.id === userId) || {};
            if(!user.first_name) {
                const { data } = await client.from('profiles').select('*').eq('id', userId).single();
                if(data) Object.assign(user, data);
            }
            document.getElementById('chat-header-name').innerText = `${user.first_name} ${user.last_name}`;
            document.getElementById('chat-header-pic').style.backgroundImage = `url('${user.avatar_url || `https://api.dicebear.com/9.x/avataaars/svg?seed=${user.first_name}`}')`;
            updateHeaderStatus(user.last_seen);

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            if(window.innerWidth <= 768) { document.getElementById('chat-area').classList.add('active'); document.getElementById('back-btn').style.display = 'block'; }
            
            await client.from('messages').update({ is_read: true }).eq('sender_id', userId).eq('receiver_id', currentUser.id);
            const userIdx = userListCache.findIndex(u => u.id === userId);
            if(userIdx > -1) { userListCache[userIdx].unread = 0; renderUserList(); }
            
            loadMessages();
            subscribeToChat();
        }

        function updateHeaderStatus(lastSeen) {
            const statusEl = document.getElementById('chat-header-status');
            const now = new Date();
            const seen = lastSeen ? new Date(lastSeen) : new Date(0);
            if ((now - seen) / 1000 / 60 < 2) statusEl.innerHTML = `<span class="dot online"></span> <span style="color:var(--success)">Online</span>`;
            else statusEl.innerHTML = `<span class="dot offline"></span> <span style="color:#666">Offline</span>`;
        }

        function closeChat() {
            activeChatUser = null;
            renderUserList();
            if(window.innerWidth > 768) { document.getElementById('chat-area').style.display = 'none'; document.getElementById('empty-state').style.display = 'flex'; }
            else { document.getElementById('chat-area').classList.remove('active'); }
            if(messageSubscription) client.removeChannel(messageSubscription);
        }

        async function loadMessages() {
            const box = document.getElementById('messages-box');
            box.innerHTML = '';
            const { data: msgs } = await client.from('messages').select(`*, reply_to:reply_to_id(content, sender_id)`).or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChatUser}),and(sender_id.eq.${activeChatUser},receiver_id.eq.${currentUser.id})`).order('created_at', { ascending: true });
            if(msgs) msgs.forEach(m => renderMessage(m));
            scrollToBottom();
        }

        function renderMessage(msg) {
            const box = document.getElementById('messages-box');
            if (document.getElementById(`msg-${msg.id}`)) return; // Avoid duplicates

            const isMe = msg.sender_id === currentUser.id;
            let replyHtml = msg.reply_to ? `<div class="quoted-msg"><strong>${msg.reply_to.sender_id === currentUser.id ? "You" : "Them"}</strong><br>${msg.reply_to.content}</div>` : '';
            let statusHtml = isMe ? `<span class="status-text ${msg.is_read ? 'read' : 'sent'}">${msg.is_read ? 'Read' : 'Sent'}</span>` : '';
            let deleteBtn = isMe ? `<div class="msg-btn btn-del" onclick="deleteMessage('${msg.id}')"><i class="fa-solid fa-trash"></i></div>` : '';

            const div = document.createElement('div');
            div.id = `msg-${msg.id}`;
            div.className = `msg-wrapper ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `
                <div class="msg">
                    ${replyHtml}${msg.content}
                    <div class="msg-meta">${formatTime(msg.created_at)} ${statusHtml}</div>
                </div>
                <div class="action-triggers">
                    ${deleteBtn}
                    <div class="msg-btn" onclick="replyToMessage('${msg.id}', '${msg.content.replace(/'/g, "\\'")}')"><i class="fa-solid fa-reply"></i></div>
                </div>`;
            box.appendChild(div);
            scrollToBottom();
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !activeChatUser) return;
            
            const tempId = 'temp-' + Date.now();
            const optimisticMsg = { 
                id: tempId, 
                content: text, 
                sender_id: currentUser.id, 
                receiver_id: activeChatUser, 
                created_at: new Date().toISOString(),
                is_read: false,
                reply_to: currentReplyId ? { content: currentReplyContent, sender_id: null } : null
            };

            renderMessage(optimisticMsg); // Optimistic UI
            input.value = ""; 
            const replyId = currentReplyId;
            cancelReply();

            const { data, error } = await client.from('messages').insert({ content: text, sender_id: currentUser.id, receiver_id: activeChatUser, reply_to_id: replyId }).select();
            if(!error) {
                document.getElementById(`msg-${tempId}`).id = `msg-${data[0].id}`;
            }
        }

        async function deleteMessage(msgId) {
            if(!confirm("Delete?")) return;
            const { error } = await client.from('messages').delete().eq('id', msgId);
            if(!error) document.getElementById(`msg-${msgId}`)?.remove();
        }

        function setupRealtime() {
            client.channel('global-chat').on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
                if (payload.eventType === 'INSERT') handleIncomingMessage(payload.new);
                if (payload.eventType === 'DELETE') document.getElementById(`msg-${payload.old.id}`)?.remove();
                if (payload.eventType === 'UPDATE' && activeChatUser) loadMessages();
            }).subscribe();
        }

        function subscribeToChat() {
            if(messageSubscription) client.removeChannel(messageSubscription);
            messageSubscription = client.channel(`chat-${activeChatUser}`).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async payload => {
                const msg = payload.new;
                if (msg.sender_id === activeChatUser) {
                    let fullMsg = msg;
                    if(msg.reply_to_id) { const { data } = await client.from('messages').select('content, sender_id').eq('id', msg.reply_to_id).single(); fullMsg.reply_to = data; }
                    renderMessage(fullMsg);
                    await client.from('messages').update({ is_read: true }).eq('id', msg.id);
                }
            }).subscribe();
        }

        async function handleIncomingMessage(msg) {
            const partnerId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
            const existing = userListCache.find(u => u.id === partnerId);
            if (existing) {
                existing.lastMsg = msg.content; existing.time = msg.created_at;
                if(msg.receiver_id === currentUser.id && partnerId !== activeChatUser) existing.unread++;
            } else { await loadInbox(); }
            renderUserList();
        }

        function toggleEmoji() { const p = document.getElementById('emoji-picker'); p.style.display = p.style.display === 'grid' ? 'none' : 'grid'; }
        function addEmoji(e) { document.getElementById('msg-input').value += e; document.getElementById('emoji-picker').style.display = 'none'; document.getElementById('msg-input').focus(); }
        function replyToMessage(id, content) { currentReplyId = id; currentReplyContent = content; document.getElementById('reply-bar').classList.add('active'); document.getElementById('reply-text').innerText = content; document.getElementById('msg-input').focus(); }
        function cancelReply() { currentReplyId = null; currentReplyContent = null; document.getElementById('reply-bar').classList.remove('active'); }
        function scrollToBottom() { const box = document.getElementById('messages-box'); box.scrollTop = box.scrollHeight; }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        function formatTime(iso) { const d = new Date(iso); return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0'); }
        function filterUsers() {
            const term = document.getElementById('search-user').value.toLowerCase();
            document.querySelectorAll('.user-item').forEach(item => { item.style.display = item.innerText.toLowerCase().includes(term) ? 'flex' : 'none'; });
        }
    </script>
</body>
</html>
